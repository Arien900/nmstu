#!/bin/sh
set -e

echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ PostgreSQL..."
while ! python -c "import socket; socket.create_connection(('db', 5432), timeout=1)" 2>/dev/null; do
  echo "  â†’ PostgreSQL ÐµÑ‰Ñ‘ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð², Ð¶Ð´Ñ‘Ð¼..."
  sleep 2
done
echo "âœ… PostgreSQL Ð³Ð¾Ñ‚Ð¾Ð²"

echo "ðŸ›  ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸..."
if ! python manage.py showmigrations pc 2>/dev/null | grep -q '\[X\]'; then
  echo "  â†’ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ â€” ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"
  
  # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ð¿ÐºÑƒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚
  mkdir -p pc/migrations
  touch pc/migrations/__init__.py

  # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÑƒÑÑ‚ÑƒÑŽ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ
  python manage.py makemigrations pc --empty --name initial --verbosity 0

  # ÐŸÐ¾Ð´Ð¼ÐµÐ½ÑÐµÐ¼ ÐµÑ‘ Ð½Ð° Ð¿Ð¾Ð»Ð½ÑƒÑŽ (Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ)
  cat > pc/migrations/0001_initial.py << 'EOF'
# Generated by Django on 2025-12-19 â€” for Vanessa's PC Configurator
from django.db import migrations, models
import django.utils.timezone

class Migration(migrations.Migration):
    initial = True
    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
    ]
    operations = [
        migrations.CreateModel(
            name='Component',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255)),
                ('category', models.CharField(max_length=100)),
                ('price', models.DecimalField(decimal_places=2, max_digits=10)),
                ('description', models.TextField(blank=True)),
                ('socket', models.CharField(blank=True, max_length=100)),
                ('chipset', models.CharField(blank=True, max_length=50)),
                ('ram_type', models.CharField(blank=True, choices=[('DDR4', 'DDR4'), ('DDR5', 'DDR5')], max_length=20)),
                ('has_pcie', models.BooleanField(default=False)),
                ('power_consumption', models.PositiveIntegerField(default=0)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(default=django.utils.timezone.now)),
            ],
            options={'abstract': False},
        ),
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('username', models.CharField(error_messages={'unique': 'A user with that username already exists.'}, help_text='Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.', max_length=150, unique=True, validators=[django.contrib.auth.validators.UnicodeUsernameValidator()], verbose_name='username')),
                ('first_name', models.CharField(blank=True, max_length=150, verbose_name='first name')),
                ('last_name', models.CharField(blank=True, max_length=150, verbose_name='last name')),
                ('email', models.EmailField(blank=True, max_length=254, verbose_name='email address')),
                ('is_staff', models.BooleanField(default=False, help_text='Designates whether the user can log into this admin site.', verbose_name='staff status')),
                ('is_active', models.BooleanField(default=True, help_text='Designates whether this user should be treated as active. Unselect this instead of deleting accounts.', verbose_name='active')),
                ('date_joined', models.DateTimeField(default=django.utils.timezone.now, verbose_name='date joined')),
                ('role', models.CharField(choices=[('guest', 'Ð“Ð¾ÑÑ‚ÑŒ'), ('user', 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ'), ('admin', 'ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€')], default='guest', max_length=10)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(default=django.utils.timezone.now)),
            ],
            options={'abstract': False},
            bases=(models.Model,),
        ),
        migrations.CreateModel(
            name='Build',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200)),
                ('total_price', models.DecimalField(decimal_places=2, default=0, max_digits=12)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='pc.user')),
            ],
            options={'abstract': False},
        ),
        migrations.CreateModel(
            name='BuildComponent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('quantity', models.PositiveSmallIntegerField(default=1)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('build', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='pc.build')),
                ('component', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='pc.component')),
            ],
            options={'abstract': False},
        ),
        migrations.CreateModel(
            name='PresetBuild',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('description', models.TextField()),
                ('target', models.CharField(choices=[('gaming', 'Ð˜Ð³Ñ€Ñ‹'), ('office', 'ÐžÑ„Ð¸Ñ'), ('streaming', 'Ð¡Ñ‚Ñ€Ð¸Ð¼Ð¸Ð½Ð³'), ('budget', 'Ð‘ÑŽÐ´Ð¶ÐµÑ‚')], max_length=50)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(default=django.utils.timezone.now)),
            ],
            options={'abstract': False},
        ),
        migrations.AddField(
            model_name='user',
            name='groups',
            field=models.ManyToManyField(blank=True, help_text='The groups this user belongs to...', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups'),
        ),
        migrations.AddField(
            model_name='user',
            name='user_permissions',
            field=models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions'),
        ),
    ]
EOF

  echo "ðŸ”§ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ð¿ÐµÑ€Ð²Ñ‹Ðµ..."
  python manage.py migrate --noinput
else
  echo "  â†’ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ ÑƒÐ¶Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹"
fi

echo "ðŸ“¦ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ Ð¸ Ð¿Ñ€ÐµÑÐµÑ‚Ñ‹ (ÐµÑÐ»Ð¸ ÐµÑ‰Ñ‘ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹)..."
python manage.py shell << 'EOF'
from pc.models import Component, PresetBuild

# ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ (Ð¸Ð´ÐµÐ¼Ð¿Ð¾Ñ‚ÐµÐ½Ñ‚Ð½Ð¾ â€” Ð½Ðµ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ)
components = [
    ("Intel Core i5-13600K", "CPU", 25000, "14 ÑÐ´ÐµÑ€, 5.1 Ð“Ð“Ñ†", "LGA1700", "B760", "", False, 181),
    ("AMD Ryzen 5 7600", "CPU", 18000, "6 ÑÐ´ÐµÑ€, AM5", "AM5", "", "", False, 65),
    ("Intel Core i3-13100", "CPU", 10000, "4 ÑÐ´Ñ€Ð°, Ð±ÑŽÐ´Ð¶ÐµÑ‚Ð½Ñ‹Ð¹", "LGA1700", "", "", False, 60),
    ("ASUS ROG Strix B760-G", "ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð½ÑÐºÐ°Ñ Ð¿Ð»Ð°Ñ‚Ð°", 18000, "LGA1700, DDR5", "LGA1700", "B760", "DDR5", True, 0),
    ("MSI PRO B650M-A", "ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð½ÑÐºÐ°Ñ Ð¿Ð»Ð°Ñ‚Ð°", 15000, "AM5, DDR5", "AM5", "B650", "DDR5", True, 0),
    ("Gigabyte H610M H", "ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð½ÑÐºÐ°Ñ Ð¿Ð»Ð°Ñ‚Ð°", 7000, "LGA1700, DDR4", "LGA1700", "H610", "DDR4", True, 0),
    ("Kingston Fury Beast 32 Ð“Ð‘ (2Ã—16)", "ÐžÐ—Ð£", 12000, "DDR5, 6000 ÐœÐ“Ñ†", "", "", "DDR5", False, 5),
    ("Crucial 16 Ð“Ð‘ DDR5", "ÐžÐ—Ð£", 6000, "DDR5, 5200 ÐœÐ“Ñ†", "", "", "DDR5", False, 3),
    ("ADATA 8 Ð“Ð‘ DDR4", "ÐžÐ—Ð£", 3000, "DDR4, 3200 ÐœÐ“Ñ†", "", "", "DDR4", False, 2),
    ("NVIDIA GeForce RTX 4070", "GPU", 65000, "12 Ð“Ð‘ VRAM", "", "", "", True, 200),
    ("Samsung 980 Pro 1 Ð¢Ð‘", "SSD", 10000, "NVMe, PCIe 4.0", "", "", "", False, 6),
    ("Samsung 970 EVO 500 Ð“Ð‘", "SSD", 5000, "NVMe, PCIe 3.0", "", "", "", False, 5),
    ("Kingston A400 480 Ð“Ð‘", "SSD", 2500, "SATA III", "", "", "", False, 3),
    ("Corsair RM850e", "Ð‘ÐŸ", 9000, "850 Ð’Ñ‚, Gold", "", "", "", False, 0),
    ("Cooler Master MWE 550", "Ð‘ÐŸ", 5000, "550 Ð’Ñ‚, Bronze", "", "", "", False, 0),
    ("DeepCool DN450", "Ð‘ÐŸ", 3000, "450 Ð’Ñ‚", "", "", "", False, 0),
    ("DeepCool AK620", "ÐžÑ…Ð»Ð°Ð¶Ð´ÐµÐ½Ð¸Ðµ", 5000, "Ð‘Ð°ÑˆÐµÐ½Ð½Ñ‹Ð¹ ÐºÑƒÐ»ÐµÑ€", "LGA1700,AM4,AM5", "", "", False, 0),
]

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð»Ð¸Ð½Ñ‹ (ÑƒÐ´Ð°Ð»Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸)
assert all(len(c) == 9 for c in components), "ÐžÑˆÐ¸Ð±ÐºÐ°: Ð½Ðµ Ð²ÑÐµ ÐºÐ¾Ñ€Ñ‚ÐµÐ¶Ð¸ Ð´Ð»Ð¸Ð½Ñ‹ 9"

print("ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð»Ð¸Ð½Ñƒ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÐºÐ¾Ñ€Ñ‚ÐµÐ¶Ð°:", len(components[0]))
for i, comp in enumerate(components):
    if len(comp) != 9:
        print("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ðµ", i, ":", comp, "â€” Ð´Ð»Ð¸Ð½Ð° =", len(comp))

for name, cat, price, desc, sock, chip, ram, pcie, power in components:
    obj, created = Component.objects.get_or_create(
        name=name,
        defaults={
            'category': cat,
            'price': price,
            'description': desc,
            'socket': sock,
            'chipset': chip,
            'ram_type': ram,
            'has_pcie': pcie,
            'power_consumption': power,
        }
    )
    if created:
        print("  âž•", name)

# ÐŸÑ€ÐµÑÐµÑ‚Ñ‹
presets = [
    ("Ð˜Ð³Ñ€Ð¾Ð²Ð°Ñ 2025", "Ð”Ð»Ñ Ð¸Ð³Ñ€ Ð² 1440p", "gaming"),
    ("ÐžÑ„Ð¸ÑÐ½Ð°Ñ Ð±Ð°Ð·Ð°", "Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¸ Zoom", "office"),
    ("Ð‘ÑŽÐ´Ð¶ÐµÑ‚Ð½Ð°Ñ", "Ð”Ð»Ñ ÑƒÑ‡Ñ‘Ð±Ñ‹ Ð¸ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ð°", "budget"),
]

for name, desc, target in presets:
    obj, created = PresetBuild.objects.get_or_create(
        name=name,
        defaults={'description': desc, 'target': target}
    )
    if created:
        print("  ðŸŽ¯", name)

print("âœ… ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ Ð¸ Ð¿Ñ€ÐµÑÐµÑ‚Ñ‹ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹")
EOF

echo "ðŸ‘‘ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ..."
python manage.py shell << EOF
import os
from django.contrib.auth import get_user_model
User = get_user_model()
username = os.getenv('ADMIN_USER', 'admin')
email = os.getenv('ADMIN_EMAIL', 'admin@example.com')
password = os.getenv('ADMIN_PASSWORD', 'secureadmin123')

if not User.objects.filter(username=username).exists():
    User.objects.create_superuser(username=username, email=email, password=password, role='admin')
    print("âœ… Ð¡ÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½:", username)
else:
    print("â™»ï¸ Ð¡ÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚")
EOF

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Gunicorn..."
exec gunicorn pc_config.wsgi:application --bind 0.0.0.0:8000 --workers 2