{% extends 'grades/base.html' %}
{% block content %}
<div class="btn-group mb-3" role="group">
  <a href="?source=db" class="btn btn-{% if source == 'db' %}primary{% else %}outline-secondary{% endif %}">–ò–∑ –±–∞–∑—ã</a>
  <a href="?source=file" class="btn btn-{% if source == 'file' %}primary{% else %}outline-secondary{% endif %}">–ò–∑ —Ñ–∞–π–ª–æ–≤</a>
</div>

{% if source == 'db' %}
  <div class="mb-3">
    <input type="text" id="search" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å—Ç—É–¥–µ–Ω—Ç—É –∏–ª–∏ –ø—Ä–µ–¥–º–µ—Ç—É...">
  </div>
  <div id="records">
    {% include 'grades/_records_table.html' %}
  </div>
{% else %}
  {% if files %}
    {% for f in files %}
      <div class="card mb-2">
        <div class="card-body">
          <p><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> {{ f.student }}</p>
          <p><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong> {{ f.subject }}</p>
          <p><strong>–û—Ü–µ–Ω–∫–∞:</strong> {{ f.grade }}</p>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">–ù–µ—Ç XML-—Ñ–∞–π–ª–æ–≤.</p>
  {% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
{% if source == 'db' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–∏—Å–∫
    document.getElementById('search').addEventListener('input', function() {
        const q = this.value;
        fetch(`{% url 'search' %}?q=` + encodeURIComponent(q))
            .then(response => response.json())
            .then(records => {
                let html = '<table class="table table-striped"><thead><tr><th>–°—Ç—É–¥–µ–Ω—Ç</th><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
                records.forEach(r => {
                    html += `<tr>
                        <td contenteditable="true" class="s" data-id="${r.id}">${r.student}</td>
                        <td contenteditable="true" class="sbj" data-id="${r.id}">${r.subject}</td>
                        <td contenteditable="true" class="g" data-id="${r.id}">${r.grade}</td>
                        <td>
                            <button class="btn btn-sm btn-warning save" data-id="${r.id}">üíæ</button>
                            <button class="btn btn-sm btn-danger del" data-id="${r.id}">üóë</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('records').innerHTML = html;
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err));
    });

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫)
    document.getElementById('records').addEventListener('click', function(e) {
        const btn = e.target.closest('.save, .del');
        if (!btn) return;

        const id = btn.dataset.id;

        if (btn.classList.contains('save')) {
            const student = document.querySelector(`.s[data-id="${id}"]`).textContent.trim();
            const subject = document.querySelector(`.sbj[data-id="${id}"]`).textContent.trim();
            const grade = document.querySelector(`.g[data-id="${id}"]`).textContent.trim();

            if (!student || !subject || !grade) {
                alert('–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
                return;
            }

            const formData = new FormData();
            formData.append('student', student);
            formData.append('subject', subject);
            formData.append('grade', grade);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch(`/api/edit/${id}/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
                }
            })
            .catch(err => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err));
        }

        if (btn.classList.contains('del')) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
            fetch(`/api/delete/${id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(() => {
                document.querySelector(`.s[data-id="${id}"]`).closest('tr').remove();
            })
            .catch(err => alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err));
        }
    });
});
</script>
{% endif %}
{% endblock %}